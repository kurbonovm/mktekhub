name: Full Stack CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    # Triggers on PRs targeting main
    branches: [main]
  # Allows manual triggering from the GitHub Actions UI
  workflow_dispatch: 

jobs:
  ## ----------------------------------------------------
  ## 1. BACKEND CI JOB (Spring Boot - Runs in Parallel)
  ## ----------------------------------------------------
  backend-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- SETUP ---
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven" 

      # --- QUALITY CHECKS ---
      - name: üßπ Run Spotless Code Formatting Check
        run: mvn spotless:check
        working-directory: ./mktekhub-backend

      # --- BUILD, TEST & COVERAGE ---
      # Runs build, unit tests, integration tests, and Jacoco coverage checks
      - name: ‚úÖ Build and Test Spring Boot Backend
        # We use 'package' to build, run tests, and generate Jacoco report
        # -Dspring.profiles.active=test ensures the tests use the H2 database setup
        run: mvn -B package -Dspring.profiles.active=test
        working-directory: ./mktekhub-backend

      # --- ARTIFACT UPLOAD (For a later CD step) ---
      - name: Upload Spring Boot Executable JAR
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          # Ensure only the final executable JAR is uploaded
          path: mktekhub-backend/target/*SNAPSHOT.jar
          if-no-files-found: error # Fail job if the JAR isn't found

  ## ----------------------------------------------------
  ## 2. FRONTEND CI JOB (React/Vite - Runs in Parallel)
  ## ----------------------------------------------------
  frontend-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- SETUP ---
      - name: ‚öõÔ∏è Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./mktekhub-frontend/package-lock.json

      # Install dependencies (npm ci is faster and locks dependencies better for CI)
      - name: ‚¨áÔ∏è Install Frontend Dependencies (npm ci)
        run: npm ci
        working-directory: ./mktekhub-frontend

      # --- QUALITY CHECKS ---
      - name: üö® Run Frontend Linting (ESLint)
        run: npm run lint
        working-directory: ./mktekhub-frontend

      - name: üé® Run Frontend Formatting Check (Prettier)
        run: npm run format:check
        working-directory: ./mktekhub-frontend
      
      # --- TESTING ---
      # üí° New Step: Run your configured Jest/Vitest tests
      - name: üß™ Run Frontend Unit Tests
        run: npm test # Or npm run test:ci if you have a CI-specific command
        working-directory: ./mktekhub-frontend

      # --- BUILD ---
      - name: üì¶ Build React/Vite Frontend
        run: npm run build
        working-directory: ./mktekhub-frontend
      
      # --- ARTIFACT UPLOAD (For a later CD step) ---
      - name: Upload Frontend Build Artifact (dist)
        uses: actions/upload-artifact@v4
        with:
          name: react-build-dist
          # Path to build output within the frontend directory (Vite usually outputs to 'dist')
          path: mktekhub-frontend/dist
          if-no-files-found: error # Fail job if the build directory isn't found